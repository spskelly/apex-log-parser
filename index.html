<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Apex Debug Log Parser</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="theme-color" content="#08080f">
<meta name="description" content="Parse Salesforce Apex debug logs into structured, filterable, color-coded views with governor limit tracking.">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* -- reset & base -- */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg-root: #08080f;
    --bg-surface: #0d0d1a;
    --bg-panel: #0a0a14;
    --border: #1a1a2e;
    --border-dim: #111;
    --text: #d4d4d4;
    --text-dim: #888;
    --text-muted: #666;
    --text-faint: #555;
    --text-ghost: #444;
    --accent: #5cc9c2;
    --soql: #f4c542;
    --dml: #e8853d;
    --debug: #5cc9c2;
    --unit: #7c8dea;
    --limit: #e05577;
    --error: #ff4444;
    --warn: #f4c542;
    --validation: #b48ade;
    --workflow: #6db36d;
    --flow: #4db8d8;
    --callout: #d4a056;
    --system: #666;
    --search-hl: #f4c542;
    --mono: 'IBM Plex Mono', monospace;
    --sans: 'IBM Plex Sans', -apple-system, sans-serif;
  }

  body {
    background: var(--bg-root);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
  }

  /* -- scrollbar -- */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #222; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #333; }

  /* -- input view -- */
  #input-view {
    max-width: 800px;
    margin: 0 auto;
    padding: 60px 24px;
  }

  .input-subtitle {
    font-size: 11px;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 2px;
    font-family: var(--mono);
    margin-bottom: 8px;
  }

  .input-title {
    font-size: 32px;
    font-weight: 700;
    color: #e8e8e8;
    letter-spacing: -0.5px;
    margin-bottom: 8px;
  }

  .input-desc {
    color: var(--text-muted);
    font-size: 14px;
    margin-bottom: 32px;
  }

  .drop-zone {
    position: relative;
    margin-bottom: 16px;
  }

  .drop-overlay {
    display: none;
    position: absolute;
    inset: 0;
    background: rgba(92,201,194,0.08);
    border: 2px dashed var(--accent);
    border-radius: 8px;
    align-items: center;
    justify-content: center;
    z-index: 10;
    font-size: 14px;
    color: var(--accent);
    font-family: var(--mono);
  }

  .drop-zone.dragging .drop-overlay { display: flex; }

  #log-input {
    width: 100%;
    height: 320px;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: #aaa;
    padding: 16px;
    font-family: var(--mono);
    font-size: 12px;
    resize: vertical;
    outline: none;
    line-height: 1.6;
  }

  #log-input:focus { border-color: #252540; }

  .input-actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .btn-primary {
    padding: 8px 20px;
    background: var(--accent);
    color: var(--bg-root);
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    font-family: var(--sans);
    transition: opacity 0.15s;
  }

  .btn-primary:hover { opacity: 0.85; }

  .input-hint {
    color: var(--text-ghost);
    font-size: 12px;
  }

  /* -- parsed view -- */
  #parsed-view { display: none; }
  #parsed-view.active { display: block; }
  #input-view.hidden { display: none; }

  /* -- header bar -- */
  .header-bar {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(8,8,15,0.93);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: 10px 20px;
  }

  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .header-title {
    font-size: 14px;
    font-weight: 700;
    color: #e8e8e8;
    letter-spacing: -0.3px;
  }

  .header-badge {
    font-size: 10px;
    color: var(--accent);
    font-family: var(--mono);
    padding: 2px 8px;
    background: rgba(92,201,194,0.1);
    border-radius: 4px;
  }

  .header-meta {
    font-size: 10px;
    color: var(--text-dim);
    font-family: var(--mono);
  }

  .header-actions {
    display: flex;
    gap: 8px;
  }

  .btn-toolbar {
    padding: 4px 12px;
    font-size: 11px;
    background: transparent;
    border: 1px solid #222;
    border-radius: 4px;
    color: var(--text-faint);
    cursor: pointer;
    font-family: var(--mono);
    transition: all 0.15s;
  }

  .btn-toolbar:hover { border-color: #333; color: var(--text-dim); }
  .btn-toolbar.active { background: rgba(224,85,119,0.15); border-color: var(--limit); color: var(--limit); }

  /* -- filters row -- */
  .filters-row {
    display: flex;
    gap: 6px;
    align-items: center;
    flex-wrap: wrap;
  }

  #search-input {
    padding: 5px 12px;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 13px;
    outline: none;
    width: 200px;
  }

  #search-input:focus { border-color: #252540; }

  .filter-sep {
    width: 1px;
    height: 20px;
    background: var(--border);
    flex-shrink: 0;
  }

  .filter-chip {
    padding: 4px 10px;
    font-size: 12px;
    font-family: var(--mono);
    background: transparent;
    border: 1px solid #222;
    border-radius: 4px;
    color: var(--text-faint);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .filter-chip:hover { border-color: #333; }

  .filter-chip .chip-count {
    opacity: 0.6;
    font-size: 10px;
  }

  /* -- main layout -- */
  .main-layout {
    display: flex;
  }

  .log-pane {
    flex: 1;
    min-width: 0;
  }

  /* -- stats bar -- */
  .stats-bar {
    display: flex;
    gap: 10px;
    padding: 14px 20px;
    overflow-x: auto;
    border-bottom: 1px solid var(--border-dim);
  }

  .stat-card {
    padding: 10px 14px;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    min-width: 100px;
    flex-shrink: 0;
  }

  .stat-value {
    font-size: 22px;
    font-weight: 700;
    font-family: var(--mono);
    letter-spacing: -0.5px;
  }

  .stat-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 2px;
  }

  .stat-sub {
    font-size: 11px;
    color: var(--text-faint);
    margin-top: 2px;
  }

  /* -- log lines -- */
  .log-line {
    padding: 3px 12px;
    font-family: var(--mono);
    font-size: 13px;
    display: flex;
    gap: 8px;
    align-items: flex-start;
    border-left: 2px solid transparent;
    white-space: pre-wrap;
    word-break: break-all;
  }

  .log-timestamp {
    color: var(--text-ghost);
    min-width: 78px;
    font-size: 12px;
    flex-shrink: 0;
  }

  .log-badge {
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 3px;
    font-weight: 600;
    min-width: 42px;
    text-align: center;
    flex-shrink: 0;
  }

  .log-content {
    word-break: break-all;
  }

  .log-line-num {
    color: var(--text-ghost);
    min-width: 40px;
    text-align: right;
    font-size: 11px;
    flex-shrink: 0;
    user-select: none;
    opacity: 0.5;
  }

  .search-hl {
    background: var(--search-hl);
    color: #000;
    border-radius: 2px;
    padding: 0 2px;
  }

  .empty-state {
    padding: 40px;
    text-align: center;
    color: var(--text-ghost);
    font-family: var(--mono);
    font-size: 13px;
  }

  /* -- limits panel -- */
  .limits-panel {
    width: 280px;
    flex-shrink: 0;
    border-left: 1px solid var(--border);
    padding: 14px 16px;
    background: var(--bg-panel);
    overflow-y: auto;
    max-height: calc(100vh - 100px);
    position: sticky;
    top: 100px;
  }

  .limits-panel.hidden { display: none; }

  .limits-title {
    font-size: 11px;
    color: var(--limit);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-family: var(--mono);
    font-weight: 600;
    margin-bottom: 14px;
  }

  .limit-row { margin-bottom: 6px; }

  .limit-header {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    font-family: var(--mono);
    margin-bottom: 2px;
  }

  .limit-name { color: #bbb; }
  .limit-name.warn { color: var(--warn); }
  .limit-name.danger { color: var(--error); }

  .limit-values { color: var(--text-faint); }

  .limit-bar-track {
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }

  .limit-bar-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.4s ease;
  }

  /* -- scroll to top -- */
  .scroll-top-btn {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-size: 16px;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 200;
    transition: opacity 0.2s, border-color 0.15s;
    font-family: var(--mono);
  }
  .scroll-top-btn:hover { border-color: var(--accent); color: var(--accent); }
  .scroll-top-btn.visible { display: flex; }

  /* -- responsive -- */
  @media (max-width: 768px) {
    .limits-panel { display: none; }
    .stats-bar { padding: 10px 12px; gap: 8px; }
    .header-bar { padding: 8px 12px; }
    #search-input { width: 140px; }
    .input-title { font-size: 24px; }
    #input-view { padding: 32px 16px; }
  }
</style>
</head>
<body>

<!-- input view -->
<div id="input-view">
  <div class="input-subtitle">Salesforce Developer Tools</div>
  <h1 class="input-title">Apex Debug Log Parser</h1>
  <p class="input-desc">Paste a debug log or drop a .log file to parse it into a structured, filterable view.</p>

  <div class="drop-zone" id="drop-zone">
    <div class="drop-overlay">Drop .log file here</div>
    <textarea id="log-input" placeholder="Paste your Salesforce debug log here..." spellcheck="false"></textarea>
  </div>

  <div class="input-actions">
    <button class="btn-primary" id="btn-parse">Parse Log</button>
    <button class="btn-primary" id="btn-browse" style="background:transparent;border:1px solid var(--accent);color:var(--accent);">Browse File</button>
    <button class="btn-primary" id="btn-sample" style="background:transparent;border:1px solid #333;color:var(--text-dim);">Load Sample</button>
    <input type="file" id="file-input" accept=".log,.txt,.debug" hidden>
    <span class="input-hint">or drag &amp; drop &middot; Ctrl+V to paste</span>
  </div>
</div>

<!-- parsed view -->
<div id="parsed-view">
  <!-- header bar -->
  <div class="header-bar">
    <div class="header-top">
      <div class="header-left">
        <span class="header-title">Apex Log Parser</span>
        <span class="header-badge" id="line-count"></span>
        <span class="header-meta" id="exec-time"></span>
      </div>
      <div class="header-actions">
        <button class="btn-toolbar" id="btn-copy">Copy</button>
        <button class="btn-toolbar active" id="btn-limits">Limits</button>
        <button class="btn-toolbar" id="btn-clear">Clear</button>
      </div>
    </div>
    <div class="filters-row" id="filters-row">
      <input type="text" id="search-input" placeholder="Search logs... (Ctrl+F)">
      <span id="search-count" style="font-size:10px;font-family:var(--mono);color:var(--text-ghost);min-width:60px;"></span>
      <div class="filter-sep"></div>
      <!-- filter chips injected by js -->
    </div>
  </div>

  <!-- main layout -->
  <div class="main-layout">
    <div class="log-pane">
      <div class="stats-bar" id="stats-bar"></div>
      <div id="log-lines"></div>
    </div>
    <div class="limits-panel" id="limits-panel">
      <div class="limits-title">Governor Limits</div>
      <div id="limits-content"></div>
    </div>
  </div>
</div>

<button class="scroll-top-btn" id="btn-scroll-top" title="Scroll to top">&#8593;</button>

<script>
// -- event type → category mapping --
const EVENT_CATEGORIES = {
  SOQL_EXECUTE_BEGIN: 'soql', SOQL_EXECUTE_END: 'soql',
  DML_BEGIN: 'dml', DML_END: 'dml',
  USER_DEBUG: 'debug', SYSTEM_DEBUG: 'debug',
  CODE_UNIT_STARTED: 'unit', CODE_UNIT_FINISHED: 'unit',
  EXECUTION_STARTED: 'execution', EXECUTION_FINISHED: 'execution',
  LIMIT_USAGE_FOR_NS: 'limit', CUMULATIVE_LIMIT_USAGE: 'limit', CUMULATIVE_LIMIT_USAGE_END: 'limit',
  FATAL_ERROR: 'error', EXCEPTION_THROWN: 'error', VALIDATION_ERROR: 'error', VALIDATION_FAIL: 'error',
  VALIDATION_RULE: 'validation', VALIDATION_FORMULA: 'validation', VALIDATION_PASS: 'validation',
  WF_RULE_EVAL_BEGIN: 'workflow', WF_RULE_EVAL_END: 'workflow',
  WF_CRITERIA_BEGIN: 'workflow', WF_CRITERIA_END: 'workflow',
  FLOW_START_INTERVIEW_BEGIN: 'flow', FLOW_START_INTERVIEW_END: 'flow',
  FLOW_ELEMENT_BEGIN: 'flow', FLOW_ELEMENT_END: 'flow',
  CALLOUT_REQUEST: 'callout', CALLOUT_RESPONSE: 'callout',
  HEAP_ALLOCATE: 'system', HEAP_DEALLOCATE: 'system',
  STATEMENT_EXECUTE: 'system', VARIABLE_SCOPE_BEGIN: 'system', VARIABLE_ASSIGNMENT: 'system',
  ENTERING_MANAGED_PKG: 'system', CONSTRUCTOR_ENTRY: 'unit', CONSTRUCTOR_EXIT: 'unit',
  METHOD_ENTRY: 'unit', METHOD_EXIT: 'unit',
  SYSTEM_METHOD_ENTRY: 'system', SYSTEM_METHOD_EXIT: 'system',
  // triggers
  TRIGGER_STARTED: 'unit', TRIGGER_FINISHED: 'unit',
  // visualforce
  VF_PAGE_MESSAGE: 'system', VF_APEX_CALL_START: 'unit', VF_APEX_CALL_END: 'unit',
  VF_SERIALIZE_VIEWSTATE_BEGIN: 'system', VF_SERIALIZE_VIEWSTATE_END: 'system',
  VF_EVALUATE_FORMULA_BEGIN: 'system', VF_EVALUATE_FORMULA_END: 'system',
  // named credentials & push
  NAMED_CREDENTIAL_REQUEST: 'callout', NAMED_CREDENTIAL_RESPONSE: 'callout',
  PUSH_NOTIFICATION_SEND: 'callout',
  // soql explain
  SOQL_EXECUTE_EXPLAIN: 'soql',
  // additional system events
  USER_INFO: 'system', STACK_FRAME_VARIABLE_LIST: 'system',
  CUMULATIVE_PROFILING_BEGIN: 'system', CUMULATIVE_PROFILING_END: 'system', CUMULATIVE_PROFILING: 'system',
  SYSTEM_MODE_ENTER: 'system', SYSTEM_MODE_EXIT: 'system',
  SAVEPOINT_SET: 'system', SAVEPOINT_ROLLBACK: 'system',
  EMAIL_QUEUE: 'system', ASYNC_APEX: 'system',
  // additional flow events
  FLOW_START_INTERVIEWS_BEGIN: 'flow', FLOW_START_INTERVIEWS_END: 'flow',
  FLOW_VALUE_ASSIGNMENT: 'flow', FLOW_ACTIONCALL_DETAIL: 'flow',
  FLOW_ASSIGNMENT_DETAIL: 'flow', FLOW_LOOP_DETAIL: 'flow',
  FLOW_RULE_DETAIL: 'flow', FLOW_BULK_ELEMENT_BEGIN: 'flow', FLOW_BULK_ELEMENT_END: 'flow',
  FLOW_CREATE_INTERVIEW_BEGIN: 'flow', FLOW_CREATE_INTERVIEW_END: 'flow',
  // additional workflow events
  WF_RULE_EVAL_VALUE: 'workflow', WF_RULE_NOT_EVALUATED: 'workflow',
  WF_FIELD_UPDATE: 'workflow', WF_ACTION: 'workflow',
  WF_ACTIONS_END: 'workflow', WF_FLOW_ACTION_BEGIN: 'workflow', WF_FLOW_ACTION_END: 'workflow',
  WF_EMAIL_ALERT: 'workflow', WF_OUTBOUND_MSG: 'workflow',
};

// -- category display config --
const CATEGORIES = {
  soql:       { color: '#f4c542', label: 'SOQL' },
  dml:        { color: '#e8853d', label: 'DML' },
  debug:      { color: '#5cc9c2', label: 'DEBUG' },
  unit:       { color: '#7c8dea', label: 'UNIT' },
  execution:  { color: '#888',    label: 'EXEC' },
  limit:      { color: '#e05577', label: 'LIMIT' },
  error:      { color: '#ff4444', label: 'ERROR' },
  validation: { color: '#b48ade', label: 'VALID' },
  workflow:   { color: '#6db36d', label: 'WF' },
  flow:       { color: '#4db8d8', label: 'FLOW' },
  callout:    { color: '#d4a056', label: 'HTTP' },
  system:     { color: '#666',    label: 'SYS' },
  header:     { color: '#9a7bd4', label: 'HDR' },
  unknown:    { color: '#555',    label: '???' },
};

const DEBUG_LEVEL_COLORS = {
  ERROR: '#ff4444', WARN: '#f4c542', INFO: '#5cc9c2',
  DEBUG: '#7c8dea', FINE: '#666', FINER: '#555', FINEST: '#444',
};

// -- filter categories shown as chips --
const FILTER_ORDER = ['debug','soql','dml','error','unit','limit','validation','workflow','flow','callout','header','system'];

// -- state --
let state = {
  lines: [],
  limits: [],
  stats: {},
  activeFilters: new Set(),
  searchTerm: '',
  hideSystem: false,
  showLimits: true,
  categoryCounts: {},
};

// -- dom refs --
const $ = (sel) => document.querySelector(sel);
const inputView = $('#input-view');
const parsedView = $('#parsed-view');
const logInput = $('#log-input');
const dropZone = $('#drop-zone');
const searchInput = $('#search-input');
const logLinesEl = $('#log-lines');
const statsBar = $('#stats-bar');
const limitsContent = $('#limits-content');
const limitsPanel = $('#limits-panel');
const filtersRow = $('#filters-row');

// -- escapes html for safe insertion --
function esc(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

// -- highlights search matches in text --
function highlight(text, term) {
  if (!term || !text) return esc(text || '');
  const escaped = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const re = new RegExp(escaped, 'gi');
  let result = '';
  let lastIndex = 0;
  let match;
  while ((match = re.exec(text)) !== null) {
    result += esc(text.slice(lastIndex, match.index));
    result += '<span class="search-hl">' + esc(match[0]) + '</span>';
    lastIndex = re.lastIndex;
  }
  result += esc(text.slice(lastIndex));
  return result;
}

// -- parses a single log line --
function parseLine(raw, lineNum) {
  const m = raw.match(/^(\d{2}:\d{2}:\d{2}\.\d+)\s*\((\d+)\)\|([A-Z_]+)\|?(.*)?$/);
  if (!m) return { lineNum, raw, category: 'header', eventType: null };

  const [, timestamp, nanos, eventType, rest = ''] = m;
  const category = EVENT_CATEGORIES[eventType] || 'unknown';
  const line = { lineNum, timestamp, nanos: +nanos, eventType, category, rest, raw };

  // extract debug specifics
  if (eventType === 'USER_DEBUG') {
    const dm = rest.match(/^\[(\d+)\]\|(\w+)\|(.*)$/s);
    if (dm) { line.debugLevel = dm[2]; line.debugMessage = dm[3]; }
  }

  // extract soql query
  if (eventType === 'SOQL_EXECUTE_BEGIN') {
    const sm = rest.match(/^\[(\d+)\]\|Aggregations:(\d+)\|(.*)$/s);
    if (sm) line.soqlQuery = sm[3];
  }

  // extract soql rows
  if (eventType === 'SOQL_EXECUTE_END') {
    const rm = rest.match(/Rows:(\d+)/);
    if (rm) line.soqlRows = +rm[1];
  }

  // extract dml info
  if (eventType === 'DML_BEGIN') {
    const dm = rest.match(/Op:(\w+)\|Type:(\w+)\|Rows:(\d+)/);
    if (dm) line.dmlInfo = { op: dm[1], type: dm[2], rows: +dm[3] };
  }

  return line;
}

// -- parses governor limits from raw text --
function parseLimits(rawLines) {
  const limitMap = new Map();
  let inBlock = false;
  for (const raw of rawLines) {
    if (raw.includes('LIMIT_USAGE_FOR_NS')) { inBlock = true; continue; }
    if (raw.includes('CUMULATIVE_LIMIT_USAGE_END')) { inBlock = false; continue; }
    if (inBlock) {
      const m = raw.match(/^\s+(.+?):\s+(\d+)\s+out of\s+(\d+)/);
      if (m) {
        const name = m[1].trim();
        const used = +m[2], max = +m[3];
        const prev = limitMap.get(name);
        if (!prev || used > prev.used) {
          limitMap.set(name, { name, used, max, pct: max > 0 ? (used / max) * 100 : 0 });
        }
      }
    }
  }
  return [...limitMap.values()];
}

// -- main parse function --
function parseLog(rawLog) {
  const rawLines = rawLog.split('\n');
  const lines = rawLines.map((r, i) => parseLine(r, i + 1));
  const limits = parseLimits(rawLines);

  // compute stats
  const soqlBegins = lines.filter(l => l.eventType === 'SOQL_EXECUTE_BEGIN');
  const soqlEnds = lines.filter(l => l.eventType === 'SOQL_EXECUTE_END');
  const dmlOps = lines.filter(l => l.eventType === 'DML_BEGIN');
  const debugLines = lines.filter(l => l.eventType === 'USER_DEBUG');
  const errors = lines.filter(l => l.category === 'error' || l.debugLevel === 'ERROR');
  const warnings = lines.filter(l => l.debugLevel === 'WARN');
  const soqlRows = soqlEnds.reduce((s, l) => s + (l.soqlRows || 0), 0);
  const dmlRows = dmlOps.reduce((s, l) => s + (l.dmlInfo ? l.dmlInfo.rows : 0), 0);

  const firstNano = lines.find(l => l.nanos)?.nanos;
  const lastNano = [...lines].reverse().find(l => l.nanos)?.nanos;
  const execTimeMs = firstNano && lastNano ? ((lastNano - firstNano) / 1e6).toFixed(1) : null;

  // category counts
  const counts = {};
  for (const l of lines) counts[l.category] = (counts[l.category] || 0) + 1;

  // parse log metadata (debug level settings from first header line)
  let metadata = null;
  const firstLine = lines[0];
  if (firstLine && firstLine.category === 'header' && firstLine.raw) {
    const metaMatch = firstLine.raw.match(/^[\d.]+\s+(.+)$/);
    if (metaMatch) {
      const parts = metaMatch[1].split(';').map(p => p.trim()).filter(Boolean);
      if (parts.length > 1 && parts.every(p => p.includes(','))) {
        metadata = parts.map(p => {
          const [name, level] = p.split(',');
          return { name, level };
        });
      }
    }
  }

  state.lines = lines;
  state.limits = limits;
  state.categoryCounts = counts;
  state.stats = {
    totalLines: lines.length,
    soqlCount: soqlBegins.length, soqlRows,
    dmlCount: dmlOps.length, dmlRows,
    debugCount: debugLines.length,
    errorCount: errors.length, warnCount: warnings.length,
    execTimeMs, metadata,
  };
}

// -- filters the parsed lines based on current state --
function getFilteredLines() {
  let lines = state.lines;
  const { activeFilters, searchTerm, hideSystem } = state;

  if (activeFilters.size > 0) {
    lines = lines.filter(l => activeFilters.has(l.category));
  }

  if (hideSystem) {
    lines = lines.filter(l => l.category !== 'system' && l.category !== 'execution');
  }

  if (searchTerm) {
    const t = searchTerm.toLowerCase();
    lines = lines.filter(l =>
      l.raw?.toLowerCase().includes(t) ||
      l.debugMessage?.toLowerCase().includes(t) ||
      l.soqlQuery?.toLowerCase().includes(t)
    );
  }

  return lines;
}

// -- renders a single log line to html --
function renderLine(line) {
  const cat = CATEGORIES[line.category] || CATEGORIES.unknown;
  const color = cat.color;
  const bg = `${color}14`;
  const term = state.searchTerm;
  const num = `<span class="log-line-num">${line.lineNum}</span>`;

  // header lines
  if (!line.eventType) {
    return `<div class="log-line" style="color:${color};background:${bg}">
      ${num}
      <span class="log-content">${highlight(line.raw, term)}</span>
    </div>`;
  }

  // user_debug
  if (line.eventType === 'USER_DEBUG') {
    const lc = DEBUG_LEVEL_COLORS[line.debugLevel] || color;
    return `<div class="log-line" style="background:${bg};border-left-color:${lc}">
      ${num}
      <span class="log-timestamp">${esc(line.timestamp)}</span>
      <span class="log-badge" style="color:${lc};background:${lc}18">${esc(line.debugLevel || '')}</span>
      <span class="log-content" style="color:var(--text)">${highlight(line.debugMessage, term)}</span>
    </div>`;
  }

  // soql begin
  if (line.eventType === 'SOQL_EXECUTE_BEGIN') {
    return `<div class="log-line" style="background:${bg};border-left-color:${color}">
      ${num}
      <span class="log-timestamp">${esc(line.timestamp)}</span>
      <span class="log-badge" style="color:${color};background:${color}18">SOQL</span>
      <span class="log-content" style="color:#c9b458">${highlight(line.soqlQuery || line.rest, term)}</span>
    </div>`;
  }

  // soql end
  if (line.eventType === 'SOQL_EXECUTE_END') {
    return `<div class="log-line" style="background:${bg};border-left:2px solid ${color}">
      ${num}
      <span class="log-timestamp">${esc(line.timestamp)}</span>
      <span style="color:${color}">↳ ${line.soqlRows != null ? line.soqlRows + ' rows returned' : esc(line.rest)}</span>
    </div>`;
  }

  // dml begin
  if (line.eventType === 'DML_BEGIN' && line.dmlInfo) {
    return `<div class="log-line" style="background:${bg};border-left-color:${color}">
      ${num}
      <span class="log-timestamp">${esc(line.timestamp)}</span>
      <span class="log-badge" style="color:${color};background:${color}18">DML</span>
      <span class="log-content"><span style="color:${color}">${esc(line.dmlInfo.op)}</span> <span style="color:var(--text)">${esc(line.dmlInfo.type)}</span> <span style="color:var(--text-dim)">(${line.dmlInfo.rows} rows)</span></span>
    </div>`;
  }

  // limit events
  if (line.category === 'limit') {
    return `<div class="log-line" style="border-left:2px solid ${color}">
      ${num}
      <span class="log-timestamp">${esc(line.timestamp)}</span>
      <span style="color:${color}">${esc(line.eventType)}</span>
    </div>`;
  }

  // default
  return `<div class="log-line" style="color:${color};background:${bg};border-left-color:${color}33;opacity:0.8">
    ${num}
    <span class="log-timestamp">${esc(line.timestamp || '')}</span>
    <span class="log-badge" style="color:${color};background:${color}18;opacity:0.7">${esc((line.eventType || '').substring(0, 8))}</span>
    <span class="log-content" style="color:var(--text-dim)">${highlight(line.rest, term)}</span>
  </div>`;
}

// -- renders stats cards --
function renderStats() {
  const s = state.stats;
  let html = '';

  const card = (label, value, color, sub) =>
    `<div class="stat-card">
      <div class="stat-value" style="color:${color}">${value}</div>
      <div class="stat-label">${label}</div>
      ${sub ? `<div class="stat-sub">${sub}</div>` : ''}
    </div>`;

  html += card('SOQL Queries', s.soqlCount, 'var(--soql)', `${s.soqlRows} rows`);
  html += card('DML Ops', s.dmlCount, 'var(--dml)', `${s.dmlRows} rows`);
  html += card('Debug Logs', s.debugCount, 'var(--debug)', '');
  if (s.errorCount > 0) html += card('Errors', s.errorCount, 'var(--error)', '');
  if (s.warnCount > 0) html += card('Warnings', s.warnCount, 'var(--warn)', '');
  if (s.execTimeMs) html += card('Exec Time', s.execTimeMs + 'ms', 'var(--unit)', '');

  if (s.metadata) {
    const levels = s.metadata.map(m =>
      `<span style="color:${DEBUG_LEVEL_COLORS[m.level] || '#888'}">${esc(m.name)}:${esc(m.level)}</span>`
    ).join(' <span style="color:var(--text-ghost)">&middot;</span> ');
    html += `<div class="stat-card" style="flex-grow:1;min-width:auto">
      <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Log Levels</div>
      <div style="font-size:11px;font-family:var(--mono);line-height:1.6">${levels}</div>
    </div>`;
  }

  statsBar.innerHTML = html;
}

// -- renders governor limits panel --
function renderLimits() {
  if (!state.limits.length) {
    limitsContent.innerHTML = '<div style="color:var(--text-ghost);font-size:12px;font-family:var(--mono)">No limit data found in log.</div>';
    return;
  }

  let html = '';
  for (const lim of state.limits) {
    const barColor = lim.pct >= 90 ? 'var(--error)' : lim.pct >= 70 ? 'var(--warn)' : lim.pct >= 40 ? 'var(--dml)' : '#3d8c6e';
    const nameClass = lim.pct >= 90 ? 'danger' : lim.pct >= 70 ? 'warn' : '';
    const shortName = lim.name.replace(/^Number of /, '').replace(/^Maximum /, '');

    html += `<div class="limit-row">
      <div class="limit-header">
        <span class="limit-name ${nameClass}">${esc(shortName)}</span>
        <span class="limit-values"><span style="color:${barColor}">${lim.used.toLocaleString()}</span> / ${lim.max.toLocaleString()}</span>
      </div>
      <div class="limit-bar-track">
        <div class="limit-bar-fill" style="width:${Math.min(lim.pct, 100)}%;background:${barColor}"></div>
      </div>
    </div>`;
  }
  limitsContent.innerHTML = html;
}

// -- renders filter chips --
function renderFilters() {
  // remove existing chips (keep search input, count, and first separator)
  const existing = filtersRow.querySelectorAll('.filter-chip, .filter-sep:not(:first-of-type)');
  existing.forEach(el => el.remove());

  for (const cat of FILTER_ORDER) {
    const count = state.categoryCounts[cat];
    if (!count) continue;

    const c = CATEGORIES[cat];
    const active = state.activeFilters.has(cat);
    const chip = document.createElement('button');
    chip.className = 'filter-chip';
    chip.style.cssText = active
      ? `background:${c.color}20;border-color:${c.color};color:${c.color}`
      : '';
    chip.innerHTML = `${c.label} <span class="chip-count">${count}</span>`;
    chip.addEventListener('click', () => {
      if (state.activeFilters.has(cat)) state.activeFilters.delete(cat);
      else state.activeFilters.add(cat);
      renderFilters();
      renderLogLines();
    });
    filtersRow.appendChild(chip);
  }

  // add hide system toggle
  const sep = document.createElement('div');
  sep.className = 'filter-sep';
  filtersRow.appendChild(sep);

  const hideChip = document.createElement('button');
  hideChip.className = 'filter-chip';
  hideChip.style.cssText = state.hideSystem
    ? 'background:var(--error)18;border-color:var(--error);color:var(--error)'
    : '';
  hideChip.textContent = 'Hide System';
  hideChip.addEventListener('click', () => {
    state.hideSystem = !state.hideSystem;
    renderFilters();
    renderLogLines();
  });
  filtersRow.appendChild(hideChip);
}

// -- renders all log lines with chunked rendering for large logs --
const RENDER_CHUNK = 2000;
let renderedCount = 0;
let currentObserver = null;

function updateLineCountBadge(filtered) {
  const total = state.lines.length;
  const shown = filtered.length;
  const badge = $('#line-count');
  if (state.activeFilters.size > 0 || state.searchTerm || state.hideSystem) {
    badge.textContent = `${shown.toLocaleString()} / ${total.toLocaleString()} lines`;
    badge.style.color = 'var(--warn)';
  } else {
    badge.textContent = `${total.toLocaleString()} lines`;
    badge.style.color = '';
  }
}

function updateSearchCount(filtered) {
  const countEl = $('#search-count');
  if (state.searchTerm) {
    countEl.textContent = `${filtered.length} match${filtered.length !== 1 ? 'es' : ''}`;
    countEl.style.color = filtered.length === 0 ? 'var(--error)' : 'var(--text-ghost)';
  } else {
    countEl.textContent = '';
  }
}

function appendLoadMoreSentinel(filtered) {
  const remaining = filtered.length - renderedCount;
  const sentinel = document.createElement('div');
  sentinel.id = 'load-more-sentinel';
  sentinel.style.cssText = 'padding:16px;text-align:center;color:var(--text-ghost);font-family:var(--mono);font-size:12px;cursor:pointer;';
  sentinel.textContent = `Showing ${renderedCount.toLocaleString()} of ${filtered.length.toLocaleString()} lines — click or scroll to load ${Math.min(RENDER_CHUNK, remaining).toLocaleString()} more`;

  if (currentObserver) { currentObserver.disconnect(); currentObserver = null; }
  const observer = new IntersectionObserver((entries) => {
    if (entries[0].isIntersecting) {
      observer.disconnect();
      loadMoreLines(filtered);
    }
  }, { rootMargin: '200px' });

  sentinel.addEventListener('click', () => {
    observer.disconnect();
    loadMoreLines(filtered);
  });

  logLinesEl.appendChild(sentinel);
  currentObserver = observer;
  observer.observe(sentinel);
}

function loadMoreLines(filtered) {
  const sentinel = $('#load-more-sentinel');
  if (sentinel) sentinel.remove();

  const start = renderedCount;
  const end = Math.min(renderedCount + RENDER_CHUNK, filtered.length);

  const fragment = document.createDocumentFragment();
  const tempDiv = document.createElement('div');
  const chunks = [];
  for (let i = start; i < end; i++) {
    chunks.push(renderLine(filtered[i]));
  }
  tempDiv.innerHTML = chunks.join('');
  while (tempDiv.firstChild) {
    fragment.appendChild(tempDiv.firstChild);
  }
  logLinesEl.appendChild(fragment);

  renderedCount = end;

  if (renderedCount < filtered.length) {
    appendLoadMoreSentinel(filtered);
  }
}

function renderLogLines() {
  if (currentObserver) { currentObserver.disconnect(); currentObserver = null; }
  const filtered = getFilteredLines();

  updateSearchCount(filtered);
  updateLineCountBadge(filtered);

  if (!filtered.length) {
    logLinesEl.innerHTML = '<div class="empty-state">No lines match your current filters.</div>';
    return;
  }

  // render first chunk
  renderedCount = Math.min(RENDER_CHUNK, filtered.length);
  const chunks = [];
  for (let i = 0; i < renderedCount; i++) {
    chunks.push(renderLine(filtered[i]));
  }
  logLinesEl.innerHTML = chunks.join('');

  // add load-more sentinel if there are remaining lines
  if (renderedCount < filtered.length) {
    appendLoadMoreSentinel(filtered);
  }
}

// -- switches to parsed view --
function showParsedView() {
  const raw = logInput.value.trim();
  if (!raw) return;

  parseLog(raw);

  inputView.classList.add('hidden');
  parsedView.classList.add('active');

  // populate header
  $('#line-count').textContent = state.stats.totalLines + ' lines';
  const execEl = $('#exec-time');
  execEl.textContent = state.stats.execTimeMs ? state.stats.execTimeMs + 'ms' : '';

  renderStats();
  renderLimits();
  renderFilters();
  renderLogLines();
}

// -- resets to input view --
function resetToInput() {
  parsedView.classList.remove('active');
  inputView.classList.remove('hidden');
  logInput.value = '';
  state = {
    lines: [], limits: [], stats: {}, activeFilters: new Set(),
    searchTerm: '', hideSystem: false, showLimits: true, categoryCounts: {},
  };
  searchInput.value = '';
}

// -- sample log --
const SAMPLE_LOG = `55.0 APEX_CODE,DEBUG;APEX_PROFILING,INFO;CALLOUT,INFO;DB,INFO;NBA,INFO;SYSTEM,DEBUG;VALIDATION,INFO;VISUALFORCE,INFO;WORKFLOW,INFO
Execute Anonymous: Account[] accts = [SELECT Id, Name, Industry FROM Account WHERE Industry != null LIMIT 10];
Execute Anonymous: for (Account a : accts) {
Execute Anonymous:     System.debug(LoggingLevel.DEBUG, 'Processing account: ' + a.Name + ' | Industry: ' + a.Industry);
Execute Anonymous: }
Execute Anonymous: Contact[] contacts = [SELECT Id, FirstName, LastName, AccountId FROM Contact WHERE AccountId IN :accts LIMIT 50];
Execute Anonymous: System.debug(LoggingLevel.INFO, 'Found ' + contacts.size() + ' contacts for ' + accts.size() + ' accounts');
Execute Anonymous: Map<Id, List<Contact>> acctContacts = new Map<Id, List<Contact>>();
Execute Anonymous: for (Contact c : contacts) {
Execute Anonymous:     if (!acctContacts.containsKey(c.AccountId)) {
Execute Anonymous:         acctContacts.put(c.AccountId, new List<Contact>());
Execute Anonymous:     }
Execute Anonymous:     acctContacts.get(c.AccountId).add(c);
Execute Anonymous: }
Execute Anonymous: for (Account a : accts) {
Execute Anonymous:     List<Contact> relatedContacts = acctContacts.get(a.Id);
Execute Anonymous:     Integer count = relatedContacts != null ? relatedContacts.size() : 0;
Execute Anonymous:     System.debug(LoggingLevel.DEBUG, a.Name + ' has ' + count + ' contacts');
Execute Anonymous: }
Execute Anonymous: System.debug(LoggingLevel.WARN, 'Batch processing complete - review governor limits');
Execute Anonymous: List<Lead> leads = [SELECT Id, Name, Status, Company FROM Lead WHERE Status = 'Open' AND CreatedDate = LAST_N_DAYS:30 LIMIT 200];
Execute Anonymous: System.debug(LoggingLevel.INFO, 'Processing ' + leads.size() + ' recent open leads');
Execute Anonymous: Integer dmlCount = 0;
Execute Anonymous: for (Lead l : leads) {
Execute Anonymous:     if (l.Company == null) {
Execute Anonymous:         l.Company = 'Unknown';
Execute Anonymous:         dmlCount++;
Execute Anonymous:     }
Execute Anonymous: }
Execute Anonymous: if (dmlCount > 0) {
Execute Anonymous:     update leads;
Execute Anonymous:     System.debug(LoggingLevel.INFO, 'Updated ' + dmlCount + ' leads with missing company');
Execute Anonymous: }
Execute Anonymous: try {
Execute Anonymous:     AggregateResult[] results = [SELECT Industry, COUNT(Id) cnt FROM Account GROUP BY Industry];
Execute Anonymous:     for (AggregateResult ar : results) {
Execute Anonymous:         System.debug(LoggingLevel.FINE, 'Industry: ' + ar.get('Industry') + ' Count: ' + ar.get('cnt'));
Execute Anonymous:     }
Execute Anonymous: } catch (Exception e) {
Execute Anonymous:     System.debug(LoggingLevel.ERROR, 'Aggregation failed: ' + e.getMessage());
Execute Anonymous: }
14:23:01.5 (1234567)|EXECUTION_STARTED
14:23:01.5 (1234890)|CODE_UNIT_STARTED|[EXTERNAL]|execute_anonymous_apex
14:23:01.8 (2345678)|SOQL_EXECUTE_BEGIN|[1]|Aggregations:0|SELECT Id, Name, Industry FROM Account WHERE Industry != null LIMIT 10
14:23:01.12 (3456789)|SOQL_EXECUTE_END|[1]|Rows:8
14:23:01.15 (4567890)|USER_DEBUG|[3]|DEBUG|Processing account: Acme Corporation | Industry: Technology
14:23:01.16 (4667890)|USER_DEBUG|[3]|DEBUG|Processing account: Global Media Inc | Industry: Communications
14:23:01.17 (4767890)|USER_DEBUG|[3]|DEBUG|Processing account: Pinnacle Financial | Industry: Finance
14:23:01.18 (4867890)|USER_DEBUG|[3]|DEBUG|Processing account: Summit Healthcare | Industry: Healthcare
14:23:01.19 (4967890)|USER_DEBUG|[3]|DEBUG|Processing account: Atlas Manufacturing | Industry: Manufacturing
14:23:01.20 (5067890)|USER_DEBUG|[3]|DEBUG|Processing account: Meridian Consulting | Industry: Consulting
14:23:01.21 (5167890)|USER_DEBUG|[3]|DEBUG|Processing account: Vertex Energy | Industry: Energy
14:23:01.22 (5267890)|USER_DEBUG|[3]|DEBUG|Processing account: Horizon Retail Group | Industry: Retail
14:23:01.25 (5567890)|SOQL_EXECUTE_BEGIN|[6]|Aggregations:0|SELECT Id, FirstName, LastName, AccountId FROM Contact WHERE AccountId IN :tmpVar1 LIMIT 50
14:23:01.32 (6234567)|SOQL_EXECUTE_END|[6]|Rows:23
14:23:01.33 (6334567)|USER_DEBUG|[7]|INFO|Found 23 contacts for 8 accounts
14:23:01.40 (7034567)|USER_DEBUG|[14]|DEBUG|Acme Corporation has 5 contacts
14:23:01.41 (7134567)|USER_DEBUG|[14]|DEBUG|Global Media Inc has 3 contacts
14:23:01.42 (7234567)|USER_DEBUG|[14]|DEBUG|Pinnacle Financial has 4 contacts
14:23:01.43 (7334567)|USER_DEBUG|[14]|DEBUG|Summit Healthcare has 2 contacts
14:23:01.44 (7434567)|USER_DEBUG|[14]|DEBUG|Atlas Manufacturing has 3 contacts
14:23:01.45 (7534567)|USER_DEBUG|[14]|DEBUG|Meridian Consulting has 1 contacts
14:23:01.46 (7634567)|USER_DEBUG|[14]|DEBUG|Vertex Energy has 3 contacts
14:23:01.47 (7734567)|USER_DEBUG|[14]|DEBUG|Horizon Retail Group has 2 contacts
14:23:01.50 (7834567)|USER_DEBUG|[16]|WARN|Batch processing complete - review governor limits
14:23:01.55 (8234567)|SOQL_EXECUTE_BEGIN|[17]|Aggregations:0|SELECT Id, Name, Status, Company FROM Lead WHERE Status = 'Open' AND CreatedDate = LAST_N_DAYS:30 LIMIT 200
14:23:01.72 (9534567)|SOQL_EXECUTE_END|[17]|Rows:47
14:23:01.73 (9634567)|USER_DEBUG|[18]|INFO|Processing 47 recent open leads
14:23:01.85 (10834567)|DML_BEGIN|[23]|Op:Update|Type:Lead|Rows:12
14:23:01.98 (11934567)|DML_END|[23]
14:23:01.99 (12034567)|USER_DEBUG|[24]|INFO|Updated 12 leads with missing company
14:23:02.05 (12534567)|SOQL_EXECUTE_BEGIN|[27]|Aggregations:1|SELECT Industry, COUNT(Id) cnt FROM Account GROUP BY Industry
14:23:02.15 (13534567)|SOQL_EXECUTE_END|[27]|Rows:6
14:23:02.16 (13634567)|USER_DEBUG|[29]|FINE|Industry: Technology Count: 15
14:23:02.17 (13734567)|USER_DEBUG|[29]|FINE|Industry: Finance Count: 8
14:23:02.18 (13834567)|USER_DEBUG|[29]|FINE|Industry: Healthcare Count: 12
14:23:02.19 (13934567)|USER_DEBUG|[29]|FINE|Industry: Communications Count: 5
14:23:02.20 (14034567)|USER_DEBUG|[29]|FINE|Industry: Manufacturing Count: 9
14:23:02.21 (14134567)|USER_DEBUG|[29]|FINE|Industry: Energy Count: 7
14:23:02.25 (14534567)|CUMULATIVE_LIMIT_USAGE
14:23:02.25 (14534567)|LIMIT_USAGE_FOR_NS|(default)|
  Number of SOQL queries: 4 out of 100
  Number of query rows: 84 out of 50000
  Number of SOSL queries: 0 out of 20
  Number of DML statements: 1 out of 150
  Number of DML rows: 12 out of 10000
  Maximum CPU time: 89 out of 10000
  Maximum heap size: 14230 out of 6000000
  Number of callouts: 0 out of 100
  Number of Email Invocations: 0 out of 10
  Number of future calls: 0 out of 50
  Number of queueable jobs added to the queue: 0 out of 50
  Number of Mobile Apex push calls: 0 out of 10
14:23:02.25 (14534567)|CUMULATIVE_LIMIT_USAGE_END
14:23:02.30 (15034567)|CODE_UNIT_FINISHED|execute_anonymous_apex
14:23:02.30 (15034567)|EXECUTION_FINISHED`;

// -- event listeners --

// auto-parse on paste when content is substantial
logInput.addEventListener('paste', () => {
  setTimeout(() => {
    if (logInput.value.trim().length > 500) showParsedView();
  }, 0);
});

// parse button
$('#btn-parse').addEventListener('click', () => {
  if (logInput.value.trim().length > 0) showParsedView();
});

// browse file button
const fileInput = $('#file-input');
$('#btn-browse').addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', (e) => {
  const file = e.target.files?.[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (ev) => { logInput.value = ev.target.result; showParsedView(); };
    reader.readAsText(file);
  }
});

// sample button
$('#btn-sample').addEventListener('click', () => {
  logInput.value = SAMPLE_LOG;
  showParsedView();
});

// clear button
$('#btn-clear').addEventListener('click', resetToInput);

// limits toggle
$('#btn-limits').addEventListener('click', () => {
  state.showLimits = !state.showLimits;
  limitsPanel.classList.toggle('hidden', !state.showLimits);
  $('#btn-limits').classList.toggle('active', state.showLimits);
});

// search
let searchTimeout;
searchInput.addEventListener('input', () => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    state.searchTerm = searchInput.value;
    renderLogLines();
  }, 150);
});

// drag and drop
dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragging'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragging'));
dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('dragging');
  const file = e.dataTransfer.files?.[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (ev) => { logInput.value = ev.target.result; showParsedView(); };
    reader.readAsText(file);
  }
});

// copy filtered results
$('#btn-copy').addEventListener('click', () => {
  const filtered = getFilteredLines();
  const text = filtered.map(l => l.raw).join('\n');
  navigator.clipboard.writeText(text).then(() => {
    const btn = $('#btn-copy');
    btn.textContent = 'Copied!';
    btn.style.color = 'var(--accent)';
    btn.style.borderColor = 'var(--accent)';
    setTimeout(() => { btn.textContent = 'Copy'; btn.style.color = ''; btn.style.borderColor = ''; }, 1500);
  });
});

// scroll to top
const scrollBtn = $('#btn-scroll-top');
window.addEventListener('scroll', () => {
  scrollBtn.classList.toggle('visible', window.scrollY > 400 && parsedView.classList.contains('active'));
});
scrollBtn.addEventListener('click', () => {
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

// keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && parsedView.classList.contains('active')) resetToInput();
  if ((e.ctrlKey || e.metaKey) && e.key === 'f' && parsedView.classList.contains('active')) {
    e.preventDefault();
    searchInput.focus();
    searchInput.select();
  }
});
</script>
<script>
// register service worker for offline support
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}
</script>
</body>
</html>
